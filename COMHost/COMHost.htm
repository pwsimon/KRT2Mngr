<HTML>

<HEAD>
	<script type="text/javascript">
/*
* weil das aktuell mit res:// geladen wird haben wir documentMode: 5, da geht kein addEventListener
window.onload = function () {
	document.getElementById("btnSend").addEventListener("click", function () {
		window.external.sendCommand("S", function () {
			console.log("callback");
		});
	});
} */

/*
* wir haben hier EINE zweite ebene (ProtocolLayer)
* das "KEEPALIVE" ('S') wird auf der ersten ebene behandelt und ist hier unsichtbar
* nachdem auf diesem Layer nichts verlorengehen kann braucht es hier auch kein ack/nak
*
* receiveCommand holt ein command. die funktion blockiert niemals.
* Hinweis(e):
* - wenn der sender die commands schneller schickt als der client sie konsumieren kann gehen sie verloren.
*/
function receiveCommand() {
	window.external.receiveCommand(function (sJSONCommand) {
		document.getElementById('command').innerText = sJSONCommand;
	});
}
function sendSingleCommand() {
	var sPing = "S",         // Interface_Ext_V18.pdf(2), 1.1 Activate the Remote connection
		sToggleActPas = "0x02 0x43", // Interface_Ext_V18.pdf(5), 1.3.2 Exchange of Frequencies (active against passive)
		sDualModeOn = "0x02 0x4f", // Interface_Ext_V18.pdf(5), 1.3.7 DUAL-mode on
		sDualModeOff = "0x02 0x6f", // Interface_Ext_V18.pdf(5), 1.3.8 DUAL-mode off
		lAccept;

	lAccept = window.external.sendCommand(sToggleActPas, function (error, result) {
		/*
		* das command accepted jetzt ist der callback garantiert
		*/
		if(error)
			document.getElementById('command').innerText = 'transmit failed with: ' + error;
		else
			document.getElementById('command').innerText = 'transmit completed';
	});
	if(lAccept)
		document.getElementById('command').innerText = 'command rejected, buffer full/busy';
}
function sendMultipleCommands() {
	var rgCommands = [
			"0x02 0x43",   // Interface_Ext_V18.pdf(5), 1.3.2 Exchange of Frequencies (active against passive)
			"0x02 0x4f",   // Interface_Ext_V18.pdf(5), 1.3.7 DUAL-mode on
			"0x02 0x6f" ], // Interface_Ext_V18.pdf(5), 1.3.8 DUAL-mode off
		nIndex = 0;

	(function fnSendCommand() {
		window.external.sendCommand(rgCommands[nIndex], function (error, result) {
			if (error)
				document.getElementById('command').innerText = 'transmit failed with: ' + error;
			else {
				document.getElementById('command').innerText = 'transmit completed';
				if (rgCommands.length > ++nIndex)
					fnSendCommand();
			}
		});
	})();
}
	</script>
</HEAD>

<BODY ID=CCOMHostDlg BGCOLOR=LIGHTGREY style="font-family:MS Shell Dlg;font-size:8">

<TABLE WIDTH=100% HEIGHT=100%>
<TR WIDTH=100% HEIGHT=45%>
<TD ID="command" ALIGN=CENTER VALIGN=BOTTOM>0x53</TD>
</TR>
<TR WIDTH=100% HEIGHT=100%>
<TD ALIGN=RIGHT VALIGN=BOTTOM>
<BUTTON STYLE="WIDTH:100" ID="btnSoft1">undefined</BUTTON>&nbsp;
<BUTTON STYLE="WIDTH:100" onclick="sendSingleCommand()">SendSingle</BUTTON>&nbsp;
<BUTTON STYLE="WIDTH:100" onclick="sendMultipleCommands()">SendMultiple</BUTTON>&nbsp;
<BUTTON STYLE="WIDTH:100" onclick="receiveCommand()">Read</BUTTON>
</TD>
</TR>
</TABLE>

</BODY>

</HTML>
