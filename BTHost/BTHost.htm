<HTML>

<HEAD>
	<meta http-equiv="X-UA-Compatible" content="IE=11" />
	<script type="text/javascript">
var cmdParser;
function CommandParser() {
	this.rgCmd = {};
	this.fnVerify; // undefined OR null laeuft hier auf das gleiche hinaus, KEINE verification routine
	this.rgKeys = [];
	this.nIndex = 0;

	// functions
	this.Drive = function (nByte) {
		var sCmd = String.fromCharCode(nByte);

		if (this.nIndex) {
			this.rgCmd[this.rgKeys[this.nIndex]] = nByte;
			this.nIndex++;
			if (this.nIndex == this.rgKeys.length) {
				return this.fnVerify ? this.fnVerify() : true;
			}
			return false;
		}

		// single byte commands
		else if ("O" == sCmd) {
			this.rgCmd = { sCmd: sCmd };
			this.fnVerify = null; // single byte commands haben generell KEINE verification function
			return true;
		}

		else if ("o" == sCmd) {
			this.rgCmd = { sCmd: sCmd };
			return true;
		}

		// MultiByte commands
		else if ("R" == sCmd) {
			this.rgCmd = { sCmd: sCmd, nMHZ: 0, nkHZ: 0, sStation0: ' ', sStation1: ' ', sStation2: ' ', sStation3: ' ', sStation4: ' ', sStation5: ' ', sStation6: ' ', sStation7: ' ', nNr: 0, nChkSum: 0 };
			/*
			* die this.fnVerify() funktion wird ausgefuehrt wenn das letzte Byte eines commands gelesen wurde
			* fnVerifyChkSum() liefert eine funktion die folgenden ausdruck verifiziert (eval): 'nMHZ' ^ 'nkHZ' == 'nChkSum'
			*/
			this.fnVerify = this.fnVerifyChkSum('nMHZ', 'nkHZ', 'nChkSum');
		}

		else if ("U" == String.fromCharCode(nByte)) {
			this.rgCmd = { sCmd: sCmd, nMHZ: 0, nkHZ: 0, sStation0: ' ', sStation1: ' ', sStation2: ' ', sStation3: ' ', sStation4: ' ', sStation5: ' ', sStation6: ' ', sStation7: ' ', nChkSum: 0 };
			this.fnVerify = null; // KEIN(E) verify (funktion) nachdem alle bytes des command gelesen wurden
		}

		this.rgKeys = Object.keys(this.rgCmd);
		this.nIndex = 1;
	}
	this.fnVerifyChkSum = function (sNamedId1, sNamedId2, sNamedIdResult) {
		return function() { return this.rgCmd[sNamedIdResult] == this.rgCmd[sNamedId1] ^ this.rgCmd[sNamedId2] };
	}
}
function OnRXSingleByte(nByte) {
	// document.getElementById('lblCommand').innerText = String.fromCharCode(nByte);
	if("S".charCodeAt(0) == nByte) {
		console.log("ping");
	}

	else if (6 == nByte) { // STX
		if (cmdParser)
			console.log("previous command unsuccessfull/interrupted");

		cmdParser = new CommandParser();
	}

	else {
		if (cmdParser) {
			if (cmdParser.Drive(nByte)) {
				console.log("finished:", cmdParser.rgCmd.sCmd);
				cmdParser = null; // enter IDLE
			}
		}
		else
			cmdParser = new CommandParser(nByte);
	}
}
function sendSingleCommand() {
	/* fire and forget
	* bytes send asynchronous and nonblocking, you will ne notified (Ack/Nak) via OnRXSingleByte
	*/
	window.external.txBytes("0x06 0x4f"); // { STX, 'O' }; // 1.2.6 DUAL-mode on
}
window.onload = function () {
	// alert("documentMode: " + document.documentMode + ", compatMode: " + document.compatMode);
	OnRXSingleByte(6); // STX
	OnRXSingleByte("O".charCodeAt(0));

	OnRXSingleByte(6); // STX
	OnRXSingleByte("U".charCodeAt(0));
	OnRXSingleByte(123);
	OnRXSingleByte(500);
	OnRXSingleByte("G".charCodeAt(0));
	OnRXSingleByte("e".charCodeAt(0));
	OnRXSingleByte("r".charCodeAt(0));
	OnRXSingleByte("a".charCodeAt(0));
	OnRXSingleByte("t".charCodeAt(0));
	OnRXSingleByte("s".charCodeAt(0));
	OnRXSingleByte("H".charCodeAt(0));
	OnRXSingleByte("f".charCodeAt(0));
	OnRXSingleByte(256); // nChkSum

	OnRXSingleByte("S".charCodeAt(0));

	OnRXSingleByte(6); // STX
	OnRXSingleByte("R".charCodeAt(0));
	OnRXSingleByte(123);
	OnRXSingleByte(500);
	OnRXSingleByte("G".charCodeAt(0));
	OnRXSingleByte("e".charCodeAt(0));
	OnRXSingleByte("r".charCodeAt(0));
	OnRXSingleByte("a".charCodeAt(0));
	OnRXSingleByte("t".charCodeAt(0));
	OnRXSingleByte("s".charCodeAt(0));
	OnRXSingleByte("H".charCodeAt(0));
	OnRXSingleByte("f".charCodeAt(0));
	OnRXSingleByte(0); // nNr (Slot)
	OnRXSingleByte(256); // nChkSum
}
	</script>
</HEAD>

<BODY ID=CBTHostDlg BGCOLOR=LIGHTGREY style="font-family:MS Shell Dlg;font-size:8">

<TABLE WIDTH=100% HEIGHT=100%>
	<TR WIDTH=100% HEIGHT=45%>
		<TD ID="lblCommand" ALIGN=CENTER VALIGN=BOTTOM>0x00</TD>
	</TR>
	<TR WIDTH=100% HEIGHT=100%>
		<TD ALIGN=RIGHT VALIGN=BOTTOM>
			<BUTTON ID="btnSoft1">undefined</BUTTON>&nbsp;
			<BUTTON ID="btnSoft2">undefined</BUTTON>&nbsp;
			<BUTTON onclick="sendSingleCommand()">sendSingleCommand</BUTTON>
		</TD>
	</TR>
</TABLE>

</BODY>
</HTML>
